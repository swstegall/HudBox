name: Release to PPA

on:
  push:
    tags:
      - "v*"

defaults:
  run:
    shell: bash
    working-directory: ./app

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        dist: [jammy, noble]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install packaging tools
        run: |
          sudo apt update
          sudo apt install -y \
          devscripts debhelper dput gnupg2 build-essential lintian fakeroot

      - name: Extract version from tag
        id: version
        run: |
          RAW_TAG="${GITHUB_REF#refs/tags/}"
          VERSION="${RAW_TAG#v}"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Generate upstream tarball (.orig.tar.gz)
        working-directory: .
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          # Archive only the app subtree as upstream, exclude debian/ via worktree attributes
          git archive --worktree-attributes \
            --prefix=hudbox-$VERSION/ \
            -o app/../hudbox_${VERSION}.orig.tar.gz HEAD:app

      - name: Setup GPG for signing
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        run: |
          export GNUPGHOME=$RUNNER_TEMP/gnupg
          mkdir -p "$GNUPGHOME"
          chmod 700 "$GNUPGHOME"
          echo "$GPG_PRIVATE_KEY" | gpg --batch --yes --import
          gpg --list-secret-keys --keyid-format LONG
          echo "GNUPGHOME=$GNUPGHOME" >> $GITHUB_ENV

      - name: Prepare debian/changelog
        env:
          DEBEMAIL: ${{ secrets.LAUNCHPAD_EMAIL }}
          DEBFULLNAME: ${{ secrets.GPG_FULL_NAME }}
          UBUNTU_DIST: ${{ matrix.dist }}
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        if: env.GPG_PRIVATE_KEY != ''
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          DEBVER="${VERSION}-0ppa1~${UBUNTU_DIST}"
          dch --package hudbox --newversion "$DEBVER" \
              --distribution "$UBUNTU_DIST" \
              --force-distribution \
              "Release $VERSION for PPA ($UBUNTU_DIST)"

      - name: Build signed source package
        env:
          DEBEMAIL: ${{ secrets.LAUNCHPAD_EMAIL }}
          DEBFULLNAME: ${{ secrets.GPG_FULL_NAME }}
          DEBSIGN_KEYID: ${{ secrets.GPG_KEY_ID }}
          DEBSIGN_GPGOPTS: "--batch --yes --pinentry-mode loopback --passphrase=${{ secrets.PPA_GPG_PASSPHRASE }}"
          UBUNTU_DIST: ${{ matrix.dist }}
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        if: env.GPG_PRIVATE_KEY != ''
        run: |
          # -S for source-only, -sa to include full orig, -d to skip local Build-Depends check
          debuild -S -sa -d
          ls -l ../*.changes

      - name: Upload to Launchpad PPA
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          DPUT_HOST: ppa:swstegall/hudbox
        if: env.GPG_PRIVATE_KEY != ''
        run: |
          CHANGES_FILE=$(ls -1 ../*.changes | head -n1)
          echo "Uploading $CHANGES_FILE to $DPUT_HOST"
          dput "$DPUT_HOST" "$CHANGES_FILE"
