name: Release to PPA

on:
  push:
    tags:
      - "v*"

defaults:
  run:
    shell: bash
    working-directory: ./app

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        dist: [jammy, noble]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt update
          sudo apt install -y \
          devscripts debhelper dput gnupg2 build-essential cmake ninja-build \
          libgtk-4-dev libwebkitgtk-6.0-dev libjson-glib-dev libglib2.0-dev pkg-config

      - name: Extract version from tag
        id: version
        run: |
          RAW_TAG="${GITHUB_REF#refs/tags/}"
          VERSION="${RAW_TAG#v}"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Generate upstream tarball (.orig.tar.gz)
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          git archive --prefix=hudbox-$VERSION/ -o ../hudbox_${VERSION}.orig.tar.gz HEAD

      - name: Import key
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        if: env.GPG_PRIVATE_KEY != ''
        run: |
          gpg --batch --yes --import <<< "$GPG_PRIVATE_KEY"
          gpg --list-secret-keys --keyid-format LONG

      - name: Import GPG key for PPA signing
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        if: env.GPG_PRIVATE_KEY != ''
        run: |
          export GNUPGHOME=$(mktemp -d)
          chmod 700 "$GNUPGHOME"
          echo 'use-agent' >> "$GNUPGHOME/gpg.conf"
          echo 'pinentry-mode loopback' >> "$GNUPGHOME/gpg.conf"
          echo "$GPG_PRIVATE_KEY" | gpg --batch --yes --import
          gpg --list-secret-keys --keyid-format LONG

      - name: Prepare debian/changelog
        env:
          DEBEMAIL: ${{ secrets.LAUNCHPAD_EMAIL }}
          DEBFULLNAME: ${{ secrets.GPG_FULL_NAME }}
          UBUNTU_DIST: ${{ matrix.dist }}
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        if: env.GPG_PRIVATE_KEY != ''
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          DEBVER="${VERSION}-0ppa1~${UBUNTU_DIST}"
          dch --package hudbox --newversion "$DEBVER" \
              --distribution "$UBUNTU_DIST" \
              --force-distribution \
              "Release $VERSION for PPA ($UBUNTU_DIST)"

      - name: Build signed source package
        env:
          DEBEMAIL: ${{ secrets.LAUNCHPAD_EMAIL }}
          DEBFULLNAME: ${{ secrets.GPG_FULL_NAME }}
          DEBSIGN_KEYID: ${{ secrets.GPG_KEY_ID }}
          DEBSIGN_GPGOPTS: "--batch --yes --pinentry-mode loopback --passphrase=${{ secrets.PPA_GPG_PASSPHRASE }}"
          UBUNTU_DIST: ${{ matrix.dist }}
          GNUPGHOME: ${{ runner.temp }}/gnupg
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        if: env.GPG_PRIVATE_KEY != ''
        run: |
          mkdir -p "$GNUPGHOME"
          chmod 700 "$GNUPGHOME"
          debuild -S -sa
          ls -l ../*.changes

      - name: Upload to Launchpad PPA
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          DPUT_HOST: ppa:swstegall/hudbox
        if: env.GPG_PRIVATE_KEY != ''
        run: |
          CHANGES_FILE=$(ls -1 ../*.changes | head -n1)
          echo "Uploading $CHANGES_FILE to $DPUT_HOST"
          dput "$DPUT_HOST" "$CHANGES_FILE"
