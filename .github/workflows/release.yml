name: Release to PPA

on:
  push:
    tags:
      - "v*"

defaults:
  run:
    shell: bash
    working-directory: ./app

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        dist: [jammy, noble]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install packaging tools
        run: |
          sudo apt update
          sudo apt install -y \
          devscripts debhelper dput gnupg2 build-essential lintian fakeroot

      - name: Extract version from tag
        id: version
        run: |
          RAW_TAG="${GITHUB_REF#refs/tags/}"
          VERSION="${RAW_TAG#v}"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Generate upstream tarball (.orig.tar.gz)
        working-directory: .
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          # Archive only the app subtree as upstream, exclude debian/ via worktree attributes
          git archive --worktree-attributes \
            --prefix=hudbox-$VERSION/ \
            -o app/../hudbox_${VERSION}.orig.tar.gz HEAD:app

      - name: Setup GPG for signing
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          GPG_KEY_ID: ${{ secrets.GPG_KEY_ID }}
          PPA_GPG_PASSPHRASE: ${{ secrets.PPA_GPG_PASSPHRASE }}
        run: |
          export GNUPGHOME=$RUNNER_TEMP/gnupg
          mkdir -p "$GNUPGHOME"
          chmod 700 "$GNUPGHOME"
          # Configure gpg-agent for non-interactive loopback pinentry
          echo 'allow-loopback-pinentry' > "$GNUPGHOME/gpg-agent.conf"
          echo 'pinentry-mode loopback' > "$GNUPGHOME/gpg.conf"
          gpgconf --kill gpg-agent || true
          # Import ASCII-armored PRIVATE key (must begin with BEGIN PGP PRIVATE KEY BLOCK)
          echo "$GPG_PRIVATE_KEY" | gpg --batch --yes --import
          echo "Imported keys (secret):"
          gpg --list-secret-keys --keyid-format LONG || true
          # Fail fast if no secret keys are present (public key only won't work)
          if ! gpg --list-secret-keys --keyid-format LONG | grep -q 'sec'; then
            echo "ERROR: No secret key was imported. Ensure secrets.GPG_PRIVATE_KEY contains your ASCII-armored PRIVATE key (not just the public key)." >&2
            exit 1
          fi
          # Quick signing self-test to validate passphrase + loopback work
          echo test > /tmp/gpgtest.txt
          gpg --batch --yes --pinentry-mode loopback --passphrase "$PPA_GPG_PASSPHRASE" -u "$GPG_KEY_ID" -as /tmp/gpgtest.txt -o /tmp/gpgtest.txt.asc
          echo "GNUPGHOME=$GNUPGHOME" >> $GITHUB_ENV

      - name: Prepare debian/changelog
        env:
          DEBEMAIL: ${{ secrets.LAUNCHPAD_EMAIL }}
          DEBFULLNAME: ${{ secrets.GPG_FULL_NAME }}
          UBUNTU_DIST: ${{ matrix.dist }}
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        if: env.GPG_PRIVATE_KEY != ''
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          DEBVER="${VERSION}-0ppa1~${UBUNTU_DIST}"
          dch --package hudbox --newversion "$DEBVER" \
              --distribution "$UBUNTU_DIST" \
              --force-distribution \
              "Release $VERSION for PPA ($UBUNTU_DIST)"

      - name: Build signed source package
        env:
          DEBEMAIL: ${{ secrets.LAUNCHPAD_EMAIL }}
          DEBFULLNAME: ${{ secrets.GPG_FULL_NAME }}
          DEBSIGN_KEYID: ${{ secrets.GPG_KEY_ID }}
          DEBSIGN_GPGOPTS: "--batch --yes --pinentry-mode loopback --passphrase=${{ secrets.PPA_GPG_PASSPHRASE }}"
          UBUNTU_DIST: ${{ matrix.dist }}
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        if: env.GPG_PRIVATE_KEY != ''
        run: |
          # -S for source-only, -sa to include full orig, -d to skip local Build-Depends check
          debuild -S -sa -d
          ls -l ../*.changes

      - name: Upload to Launchpad PPA
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          DPUT_HOST: ppa:swstegall/hudbox
        if: env.GPG_PRIVATE_KEY != ''
        run: |
          CHANGES_FILE=$(ls -1 ../*.changes | head -n1)
          echo "Uploading $CHANGES_FILE to $DPUT_HOST"
          dput "$DPUT_HOST" "$CHANGES_FILE"
